<!--inserire nella pagina per importare la navbar
VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV
<div id="nav-placeholder"></div>
<script>
	$(function () {
		$("#nav-placeholder").load("navbar.html");
	});
</script>
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^-->

<!-- css loading && GOOGLE meta injection -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
	// carica il css della pagina
	$('<link>').appendTo('head').attr({
		type: 'text/css',
		rel: 'stylesheet',
		href: 'css/navbar.css'
	});
	
	$('<meta>').appendTo('head').attr({
		name: "google-signin-client_id",
		content: "508493289721-mi2g5njrlan5oue6n1h64b2lroc28nu4.apps.googleusercontent.com"
	});
	
	//regola la visualizzazione dell' account nella navbar
	function showAccountInfo(logged) {
		if (logged) {
			$(".register").remove();
			$(".login").remove();
		} else {
			$("a.item").remove();
		}
	}
	
	async function requestSuggestion(data) {
		return $.ajax({
			url: "https://game-syllabus-proxy.group64.workers.dev/?https://api.igdb.com/v4/games",
			type: "POST",
			crossDomain: true,
			dataType: "json",
			headers: {
				"Client-ID": "eof600pvnu4zmfzrgf1mmmgwhugt72",
				"Authorization": "Bearer dwg48lh6ge8576eju90dh266jbp40n"
			},
			data: 'fields name, platforms.name, cover.image_id; search "$"; limit 4;'.replace("$", data)
		});
	}
	
	//ragionare sulle dimensioni-max delle parti
	async function showQueryResults() {
		if (suggestion()) {
			const arr = await requestSuggestion($(".search-box")[0].value);
			arr.forEach(a => {
				var cover;
				var platform;
				try {
					cover = "https://images.igdb.com/igdb/image/upload/t_cover_small/$.jpg".replace("$", a.cover.image_id);
					platform = a.platforms[0].name;
				} catch (e) {
					console.log("missing non-critical data...");
					platform = "no data..."
				}
				const name = a.name;
				
				const img = $("<img>").prop("src", cover);
				const n = $("<p>").html(name);
				const p = $("<p>").html(platform);
				var $res = $("<span>").addClass("result-item");
				
				$res.append(img);
				$res.append(n);
				$res.append(p);
				var $link = $("<a>");
				$link.attr("href", "http://localhost:8080/game?name="+a.name);
				$link.append($res);
				$(".dropdown-content").append($link);
			});
		}
	}
	
	function empty(){
		$("span.dropdown-content").empty();
	}
	
	//visualizza o nasconde i risultati suggeriti
	function suggestion() {
		const $x = $(".dropdown-content");
		$x.html("");
		const len = $(".search-box")[0].value.length;
		if (len >= 4) {
			$x.css("display", "flex");
			return true;
		} else {
			$x.css("display", "none");
			return false;
		}
	}
	
	function hamburgerMenu() {
		$(".hamburger-menu").toggleClass("visible");
	}
</script>

<!-- GOOGLE -->
<!-- forse non serve il primo?? -->
<script src="https://apis.google.com/js/platform.js" async defer></script>
<script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>

<!-- FACEBOOK -->
<script>
	window.fbAsyncInit = function () {
		FB.init({
			appId: '{904598133610405}',
			cookie: true,
			xfbml: true,
			version: '{v9.0}'
		});
		FB.AppEvents.logPageView();
	};
	
	(function (d, s, id) {
		var js, fjs = d.getElementsByTagName(s)[0];
		if (d.getElementById(id)) {
			return;
		}
		js = d.createElement(s);
		js.id = id;
		js.src = "https://connect.facebook.net/en_US/sdk.js";
		fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));
</script>
<script async defer crossorigin="anonymous"
        src="https://connect.facebook.net/it_IT/sdk.js#xfbml=1&version=v9.0&appId=904598133610405&autoLogAppEvents=1"
        nonce="e8iPCl2W"></script>
<div id="fb-root"></div>

<!-- NAVBAR -->
<nav>
	<ul class="nav">
		<li class="search">
			<!-- Esportare in 50x50 per ottimizzare -->
			<a class="logo" href="http://localhost:8080/"><img src="images/logo.png" width="50" height="50" alt="logo"></a>
			<div class="dropdown">
				<input class="search-box" type="search" placeholder="Search..." id="nav-search" onemptied="empty()" onsearch="showQueryResults()">
				<span class="dropdown-content"></span>
				<span class="icon" onclick="showQueryResults()"><i class="material-icons">search</i></span>
			</div>
			<span class="icon hamburger" onclick="hamburgerMenu()"><i class="material-icons">menu</i></span>
			<span class="hamburger-menu">
				<a href="#">Games</a>
				<a href="http://localhost:8080/developers?start=0">Developers</a>
				<a href="#">About Us</a>
				<a href="#">Platforms</a>
				<a href="http://localhost:8080/genres">Genres</a>
				<a class="item" href="#">VeryLongUsernameOver</a>
				<a class="register" href="http://localhost:8080/regPage">Register</a>
				<a href="#" class="login" id="myBtn2" data-toggle="modal" data-target="#myModal">Login</a>
			</span>
		</li>
		
		<li class="item">
			<span class="menu material-icons">menu</span>
			<a href="#">Games</a>
			<a href="http://localhost:8080/developers?start=0">Developers</a>
			<a href="#">About Us</a>
			<a href="#">Platforms</a>
			<a href="http://localhost:8080/genres">Genres</a>   <!-- Muovere in About us? -->
		</li>
		
		<!-- usare showAccountInfo(true|false) -->
		<li class="item account">
			<a class="item" href="#">
				<span class="profile-pic material-icons">account_circle</span> <!-- Cerchio?? -->
				<span class="profile-name">VeryLongUsernameOver</span> <!-- Lunghezza massima?? -->
			</a>
			<a class="register" href="http://localhost:8080/regPage">Register</a>
			<a class="login" id="myBtn" href="#" data-toggle="modal" data-target="#myModal">Login</a>
		</li>
	</ul>
</nav>

<!-- MODAL FORM -->
<div id="myModal" class="modal">
	<!-- Modal content -->
	<div class="modal-content">
		<div class="modal-header">
			<span class="close" onclick="modal.style.display='none';">&times;</span>
			<h1>Login</h1>
		</div>
		<div class="modal-body">
			<form method="post" action="http://localhost:8080/doLogin">
				<p class="campo">Email</p>
				<input type="email" placeholder="Insert your email.." name="email">
				<p class="campo">Password</p>
				<input type="password" placeholder="Insert your password.." name="password">
				<div class="loginButtons">
					<div class="fb-login-button" data-width="" data-size="medium" data-button-type="login_with"
					     data-layout="default" data-auto-logout-link="false" data-use-continue-as="false"></div>
					<div id="my-signin2"></div>
					<script>
						function onSuccess(googleUser) {
							console.log('Logged in as: ' + googleUser.getBasicProfile().getName());
							var profile = googleUser.getBasicProfile();
							console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
							console.log('Name: ' + profile.getName());
							console.log('Image URL: ' + profile.getImageUrl());
							console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.
							scegliUsername();
						}
						
						function onFailure(error) {
							console.log(error);
						}
						
						function scegliUsername() {
							window.location.href = 'http://localhost:8080/chooseUsername';
							
						}
						
						function renderButton() {
							gapi.signin2.render('my-signin2', {
								'scope': 'profile email',
								'width': 173,
								'height': 28,
								'longtitle': true,
								'theme': 'dark',
								'onsuccess': onSuccess,
								'onfailure': onFailure
							});
						}
					</script>
				</div>
				<input type="submit" value="Login" class="modalLogin">
			</form>
		</div>
	</div>
</div>
<script defer>
	// Get the button that opens the modal
	var btn = document.getElementById("myBtn");
	var btn2 = document.getElementById("myBtn2");
	
	// When the user clicks the button, open the modal
	btn.onclick = function () {
		modal.style.display = "block";
	}
	btn2.onclick = function () {
		modal.style.display = "block";
	}
	// Get the modal
	var modal = document.getElementById("myModal");
	
	// Get the <span> element that closes the modal
	var span = document.getElementsByClassName("close")[0];
	
	
	// When the user clicks on <span> (x), close the modal
	span.onclick = function () {
		modal.style.display = "none";
	}
	
	// When the user clicks anywhere outside of the modal, close it
	window.onclick = function (event) {
		if (event.target == modal) {
			modal.style.display = "none";
		}
	}
</script>